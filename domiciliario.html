<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conductor | RUTA LOCAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #2d3436; color: white; }
        .header { background: #00b894; padding: 20px; text-align: center; font-weight: bold; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .alerta-card { background: white; color: #333; padding: 25px; border-radius: 20px; text-align: center; display: none; animation: flash 1s infinite; }
        @keyframes flash { 0% { box-shadow: 0 0 5px #f1c40f; } 50% { box-shadow: 0 0 20px #f1c40f; } 100% { box-shadow: 0 0 5px #f1c40f; } }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 1.1rem; }
        .btn-aceptar { background: #00b894; color: white; }
        .btn-entregar { background: #0984e3; color: white; }
        .espera { color: #aaa; text-align: center; margin-top: 50px; }
    </style>
</head>
<body>

<div class="header">RUTA LOCAL - MOTO ACTIVA</div>

<div class="container">
    <div id="esperando" class="espera">
        <p>Buscando pedidos en Caucasia...</p>
        <small>Toca cualquier parte para activar sonido</small>
    </div>

    <div id="alerta" class="alerta-card">
        <h2 style="color: #e67e22; margin-top: 0;">¡HAY TRABAJO!</h2>
        <p id="datos-pedido"></p>
        <button id="btn-accion" class="btn btn-aceptar" onclick="gestionarPedido()">ACEPTAR RUTA</button>
    </div>
</div>

<audio id="sonido" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // === PEGA AQUÍ EL MISMO OBJETO FIREBASE ===
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_PROYECTO.firebaseapp.com",
        projectId: "TU_PROYECTO_ID",
        storageBucket: "TU_PROYECTO.appspot.com",
        messagingSenderId: "TU_SENDER",
        appId: "TU_APP_ID"
    };
    // ==========================================

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let pedidoID = "";
    const audio = document.getElementById('sonido');

    // Escuchar solo pedidos pendientes
    db.collection("pedidos").where("estado", "==", "pendiente").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                pedidoID = change.doc.id;
                const p = change.doc.data();
                document.getElementById('esperando').style.display = "none";
                document.getElementById('alerta').style.display = "block";
                document.getElementById('datos-pedido').innerHTML = `<b>Destino:</b> ${p.direccion}<br><b>Valor:</b> $${p.valor}`;
                audio.play().catch(() => console.log("Clic para activar audio"));
            }
        });
    });

    function gestionarPedido() {
        const btn = document.getElementById('btn-accion');
        
        if (btn.innerText === "ACEPTAR RUTA") {
            db.collection("pedidos").doc(pedidoID).update({ estado: "en_camino" });
            btn.innerText = "MARCAR COMO ENTREGADO";
            btn.className = "btn btn-entregar";
        } else {
            db.collection("pedidos").doc(pedidoID).update({ estado: "completado" });
            location.reload(); // Reinicia para buscar nuevos
        }
    }

    // Activar audio por interacción
    document.body.addEventListener('click', () => audio.load());
</script>
</body>
</html>
