<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domiciliario | RUTA LOCAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #2d3436; color: white; text-align: center; }
        .header { background: #00b894; padding: 20px; font-weight: bold; border-bottom: 4px solid #f39c12; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        
        /* SECCI√ìN MIS DATOS */
        .card-moto { background: #353b48; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #4b515d; }
        input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: none; font-family: inherit; }
        
        /* ALERTA DE PEDIDO */
        .alerta { background: white; color: #2d3436; padding: 20px; border-radius: 20px; display: none; text-align: left; box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); border: 2px solid #f39c12; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 10px; }
        .btn-aceptar { background: #00b894; color: white; }

        /* SECCI√ìN HISTORIAL */
        .historial-box { margin-top: 30px; text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; }
        .historial-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 8px; font-size: 0.85rem; border-left: 4px solid #00b894; }
        .historial-item b { color: #f39c12; }
        .resumen { font-size: 1.2rem; font-weight: bold; color: #55efc4; margin-bottom: 15px; display: block; }
    </style>
</head>
<body>
    <div class="header">MODO DOMICILIARIO<br><small>Vibras Positivas ¬©</small></div>
    
    <div class="container">
        <div class="card-moto">
            <label style="font-size: 0.8rem; opacity: 0.8;">Mis Datos de Trabajo:</label>
            <input type="text" id="miNombre" placeholder="Tu Nombre">
            <input type="text" id="miPlaca" placeholder="Placa de tu Moto">
        </div>

        <div id="status">Esperando pedidos en Caucasia... üõ∞Ô∏è</div>

        <div id="tarjeta-pedido" class="alerta">
            <h2 style="color:#e67e22; text-align:center; margin-top:0;">¬°NUEVA RUTA!</h2>
            <div id="info-pedido"></div>
            <button id="btn-accion" class="btn btn-aceptar" onclick="gestionar()">ACEPTAR RUTA</button>
        </div>

        <div class="historial-box">
            <span class="resumen" id="total-ganado">Total Entregas: 0</span>
            <h3 style="margin-top:0; font-size:1rem; opacity:0.7;">Mi Historial de Hoy:</h3>
            <div id="lista-historial">
                </div>
            <button onclick="borrarHistorial()" style="background:none; border:none; color:#ff7675; font-size:0.7rem; cursor:pointer; margin-top:10px;">Limpiar historial</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCPMFCTXUvfzgW9zp-op9yl4JkhzRa_lI",
            authDomain: "ruta-local-caucasia-55f0b.firebaseapp.com",
            projectId: "ruta-local-caucasia-55f0b",
            storageBucket: "ruta-local-caucasia-55f0b.firebasestorage.app",
            messagingSenderId: "1080436819425",
            appId: "1:1080436819425:web:c13614086f5a2226423ea0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let pedidoId = "";
        let pedidoActualTemporal = null;

        // Recuperar datos guardados
        document.getElementById('miNombre').value = localStorage.getItem('motoNom') || "";
        document.getElementById('miPlaca').value = localStorage.getItem('motoPla') || "";
        actualizarVistaHistorial();

        // Escuchar pedidos pendientes
        db.collection("pedidos").where("estado", "==", "pendiente").onSnapshot(snap => {
            if(!snap.empty) {
                const doc = snap.docs[0]; pedidoId = doc.id; 
                pedidoActualTemporal = doc.data();
                document.getElementById('status').style.display = "none";
                document.getElementById('tarjeta-pedido').style.display = "block";
                document.getElementById('info-pedido').innerHTML = `
                    <b>Recoger en:</b> ${pedidoActualTemporal.comercio}<br>
                    <b>Llevar a:</b> ${pedidoActualTemporal.direccion}<br>
                    <b>Valor a Cobrar:</b> $${pedidoActualTemporal.valor}`;
            } else {
                document.getElementById('status').style.display = "block";
                document.getElementById('tarjeta-pedido').style.display = "none";
            }
        });

        function gestionar() {
            const nom = document.getElementById('miNombre').value;
            const pla = document.getElementById('miPlaca').value;
            if(!nom || !pla) return alert("Socio, primero pon tu nombre y placa.");

            localStorage.setItem('motoNom', nom);
            localStorage.setItem('motoPla', pla);

            const btn = document.getElementById('btn-accion');
            if(btn.innerText === "ACEPTAR RUTA") {
                db.collection("pedidos").doc(pedidoId).update({ 
                    estado: "en_camino", moto_nombre: nom, placa: pla 
                });
                btn.innerText = "ENTREGA FINALIZADA ‚úÖ";
                btn.style.background = "#0984e3";
            } else {
                // AL FINALIZAR: Guardamos en el historial local antes de limpiar
                guardarEnHistorial(pedidoActualTemporal);
                db.collection("pedidos").doc(pedidoId).update({ estado: "completado" });
                alert("Ruta completada. ¬°Vibras Positivas!");
                location.reload();
            }
        }

        // --- FUNCIONES DEL HISTORIAL LOCAL ---
        function guardarEnHistorial(pedido) {
            let historial = JSON.parse(localStorage.getItem('miHistorial')) || [];
            const info = {
                comercio: pedido.comercio,
                valor: pedido.valor,
                hora: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };
            historial.unshift(info); // Agregar al inicio
            localStorage.setItem('miHistorial', JSON.stringify(historial));
        }

        function actualizarVistaHistorial() {
            const historial = JSON.parse(localStorage.getItem('miHistorial')) || [];
            const lista = document.getElementById('lista-historial');
            const resumen = document.getElementById('total-ganado');
            lista.innerHTML = "";
            
            resumen.innerText = `Total Entregas: ${historial.length}`;

            historial.forEach(item => {
                lista.innerHTML += `
                    <div class="historial-item">
                        <span>${item.hora}</span> | <b>${item.comercio}</b><br>
                        Entregado con √©xito - $${item.valor}
                    </div>
                `;
            });
        }

        function borrarHistorial() {
            if(confirm("¬øQuieres borrar tu lista de hoy?")) {
                localStorage.removeItem('miHistorial');
                actualizarVistaHistorial();
            }
        }
    </script>
</body>
</html>
