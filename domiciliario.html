<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domiciliario | RUTA LOCAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #2d3436; color: white; text-align: center; }
        .header { background: #00b894; padding: 20px; font-weight: bold; }
        .container { padding: 20px; }
        .card-trabajo { background: white; color: #333; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; margin-top: 10px; font-size: 1rem; cursor: pointer; }
        .btn-aceptar { background: #00b894; color: white; }
        .logo-vibras { color: #f39c12; font-size: 0.8rem; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<div class="header">
    MODO DOMICILIARIO
    <span class="logo-vibras">Propiedad de Vibras Positivas ©</span>
</div>

<div class="container">
    <div id="espera">Esperando pedidos en Caucasia...</div>
    
    <div id="pedido-alerta" class="card-trabajo">
        <h2>¡NUEVO PEDIDO!</h2>
        <p id="info"></p>
        <button class="btn btn-aceptar" id="btn-main" onclick="aceptar()">ACEPTAR RUTA</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { /* TUS DATOS */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentId = "";

    // ACTIVAR GPS
    function transmitirGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                db.collection("ubicaciones").doc("moto_activa").set({
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    timestamp: new Date()
                });
            }, err => console.log(err), { enableHighAccuracy: true });
        }
    }

    // Escuchar pedidos
    db.collection("pedidos").where("estado", "==", "pendiente").onSnapshot(snap => {
        snap.forEach(doc => {
            currentId = doc.id;
            const p = doc.data();
            document.getElementById('espera').style.display = "none";
            document.getElementById('pedido-alerta').style.display = "block";
            document.getElementById('info').innerHTML = `Dir: ${p.direccion}<br>Cobrar: $${p.valor}`;
        });
    });

    function aceptar() {
        const btn = document.getElementById('btn-main');
        if(btn.innerText === "ACEPTAR RUTA") {
            db.collection("pedidos").doc(currentId).update({ estado: "en_camino" });
            transmitirGPS(); // Empezar a mandar ubicación
            btn.innerText = "ENTREGADO ✅";
            btn.style.background = "#0984e3";
        } else {
            db.collection("pedidos").doc(currentId).update({ estado: "completado" });
            location.reload();
        }
    }
</script>
</body>
</html>
