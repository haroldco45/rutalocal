<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domiciliario | RUTA LOCAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #2d3436; color: white; text-align: center; }
        .header { background: #00b894; padding: 20px; font-weight: bold; }
        .alerta { background: white; color: #333; padding: 20px; border-radius: 15px; margin: 20px; display: none; }
        .btn { width: 90%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">MODO MOTO ACTIVA <br> <small>Vibras Positivas ©</small></div>
    <div id="buscando">Buscando pedidos en Caucasia...</div>
    <div id="caja-pedido" class="alerta">
        <h2 style="color:#e67e22">¡NUEVO PEDIDO!</h2>
        <p id="detalles"></p>
        <button id="accion" class="btn btn-aceptar" style="background:#00b894; color:white;" onclick="gestionar()">ACEPTAR RUTA</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCPMFCTXUvfzgW9zp-op9yl4JkhzRa_lI",
            authDomain: "ruta-local-caucasia-55f0b.firebaseapp.com",
            projectId: "ruta-local-caucasia-55f0b",
            storageBucket: "ruta-local-caucasia-55f0b.firebasestorage.app",
            messagingSenderId: "1080436819425",
            appId: "1:1080436819425:web:c13614086f5a2226423ea0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let pedidoId = "";

        function activarGPS() {
            navigator.geolocation.watchPosition(pos => {
                db.collection("ubicaciones").doc("moto_activa").set({
                    lat: pos.coords.latitude, lng: pos.coords.longitude, fecha: new Date()
                });
            }, null, { enableHighAccuracy: true });
        }

        db.collection("pedidos").where("estado", "==", "pendiente").onSnapshot(snap => {
            snap.forEach(doc => {
                pedidoId = doc.id;
                const p = doc.data();
                document.getElementById('buscando').style.display = "none";
                document.getElementById('caja-pedido').style.display = "block";
                document.getElementById('detalles').innerHTML = `Dir: ${p.direccion}<br>Valor: $${p.valor}`;
            });
        });

        function gestionar() {
            const btn = document.getElementById('accion');
            if(btn.innerText === "ACEPTAR RUTA") {
                db.collection("pedidos").doc(pedidoId).update({ estado: "en_camino" });
                activarGPS();
                btn.innerText = "ENTREGADO ✅";
                btn.style.background = "#0984e3";
            } else {
                db.collection("pedidos").doc(pedidoId).update({ estado: "completado" });
                location.reload();
            }
        }
    </script>
</body>
</html>
